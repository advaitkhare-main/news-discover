name: Update News JSON
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install feedparser
      run: pip3 install feedparser
    
    - name: Generate news.json
      run: |
        python3 << 'EOF'
        import feedparser
        import json
        from datetime import datetime
        
        feeds = [
            {"url": "https://feeds.feedburner.com/ndtvnews-latest", "cat": "india", "src": "NDTV"},
            {"url": "https://feeds.bbci.co.uk/news/rss.xml", "cat": "global", "src": "BBC"},
            {"url": "https://venturebeat.com/category/ai/feed/", "cat": "scitech", "src": "VentureBeat"},
            {"url": "https://economictimes.indiatimes.com/markets/rssfeeds/1977021501.cms", "cat": "finance", "src": "ET"},
            {"url": "https://www.espncricinfo.com/rss/content/story/feeds/0.xml", "cat": "sports", "src": "Cricinfo"},
            {"url": "https://www.lokmat.com/rss/", "cat": "marathi", "src": "Lokmat"}
        ]
        
        news = []
        for f in feeds:
            print(f"Fetching {f['src']}...")
            try:
                d = feedparser.parse(f["url"])
                for entry in d.entries[:8]:
                    news.append({
                        "id": entry.get("id", entry.link),
                        "category": f["cat"],
                        "title": entry.get("title", "News")[:100],
                        "summary": entry.get("summary", "")[:200],
                        "image": "https://picsum.photos/400/250?news",
                        "source": f["src"],
                        "pubDate": entry.get("published", str(datetime.now())),
                        "link": entry.get("link", "#")
                    })
                print(f"  âœ“ {len(d.entries)} items")
            except Exception as e:
                print(f"  âœ— {e}")
        
        news.sort(key=lambda x: x["pubDate"], reverse=True)
        with open("docs/news.json", "w") as fp:
            json.dump(news[:50], fp, indent=2)
        print(f"\nðŸŽ‰ SAVED {len(news)} articles to news.json!")
        EOF
    
    - name: Commit & Push
      uses: stefanzweifel/git-auto-commit-action@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        commit_message: "ðŸ¤– Update news.json {{ github.run_id }}"
        file_pattern: docs/news.json
